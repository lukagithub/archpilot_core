%% ========================================
%% ArchPilot Core å…¨å±€ Pilot æµç¨‹å›¾
%% è§’è‰²ï¼šç³»ç»Ÿæ¶æ„å¸ˆ / è½¯ä»¶æ¶æ„å·¥ç¨‹å¸ˆ
%% è¯´æ˜ï¼šå±•ç¤ºå¦‚ä½•ä½¿ç”¨æ•´ä¸ªå·¥ç¨‹çš„æ–‡æ¡£èµ„äº§æ¨è¿›é¡¹ç›®è¿­ä»£
%% ========================================

flowchart TB
    %% ==================== è§’è‰²å…¥å£ ====================
    subgraph Role["ğŸ‘¤ ç³»ç»Ÿ/è½¯ä»¶æ¶æ„å·¥ç¨‹å¸ˆ"]
        direction LR
        R1["ğŸ›ï¸ æ¶æ„è®¾è®¡"] ~~~ R2["ğŸ’» å¼€å‘æŒ‡å¯¼"] ~~~ R3["ğŸ” è´¨é‡æŠŠæ§"] ~~~ R4["ğŸš€ ç‰ˆæœ¬å‘å¸ƒ"]
    end

    %% ==================== å›¾ä¾‹ï¼ˆæ–‡æ¡£ç»´åº¦é¢œè‰²ï¼‰ ====================
    subgraph Legend["ğŸ“š æ–‡æ¡£é“¾/è¿‡ç¨‹äº§ç‰©"]
        direction LR
        subgraph LG1["Coreæ–‡ä»¶(å†·è‰²)"]
            direction LR
            L1[/"Entry"/] ~~~ L2[/"Rules"/] ~~~ L3[/"Workflow"/] ~~~ L4[/"Templates"/] ~~~ L5[/"Scripts"/]
        end
        subgraph LG2["è¿‡ç¨‹äº§ç‰©(æš–è‰²)"]
            direction LR
            L6[/"Output"/]
        end
        LG1 ~~~ LG2
    end

    %% ==================== åˆå§‹åŒ–ï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰ ====================
    subgraph Init["ğŸš€ åˆå§‹åŒ–ï¼ˆä¸€æ¬¡æ€§ï¼‰"]
        direction TB
        I1["â‘  ç†è§£æ¡†æ¶"]
        I_D1[/"README.md"/]
        I_D2[/"QUICK_START.md"/]
        I2["â‘¡ éƒ¨ç½²é¡¹ç›®"]
        I_D3[/"deploy_project.sh"/]
        I1 --- I_D1 & I_D2
        I_D1 & I_D2 --- I2
        I2 --- I_D3
    end

    %% ==================== Pilot è¿­ä»£å‘¨æœŸï¼ˆæ ¸å¿ƒï¼‰ ====================
    subgraph Phases["ğŸ“… åŸºäº ArchPilot Core çš„è¿­ä»£è¿‡ç¨‹"]
        direction LR

        subgraph P1["Gate1 è§„åˆ’"]
            direction TB
            P1_S["â‘  è§„åˆ’/å¾®è°ƒè¿­ä»£"]
            P1_D1[/"flow_planning.md"/]
            P1_D2[/"ARCHITECTURE_DEFINITION.md"/]
            P1_S --- P1_D1 & P1_D2
        end

        subgraph P2["Gate2 è®¾è®¡"]
            direction TB
            P2_S["â‘  L1 éœ€æ±‚"]
            P2_D1[/"ARCHITECTURE_DEFINITION.md"/]
            P2_D2[/"requirement_template.md"/]
            P2_M["â‘¡ L2 æ¶æ„"]
            P2_D3[/"architecture_template.md"/]
            P2_E["â‘¢ L3 è®¾è®¡"]
            P2_D4[/"design_template.md"/]
            P2_D5[/"rules_naming.md"/]
            P2_S --- P2_D1 & P2_D2
            P2_D1 & P2_D2 --- P2_M
            P2_M --- P2_D3
            P2_D3 --- P2_E
            P2_E --- P2_D4 & P2_D5
        end

        subgraph P3["Gate3 å®ç°"]
            direction TB
            P3_S["â‘  L4 ä»£ç "]
            P3_D1[/"rules_coding.md"/]
            P3_D2[/"flow_implement.md"/]
            P3_M["â‘¡ L5 æµ‹è¯•"]
            P3_D3[/"testcase_template.md"/]
            P3_E["â‘¢ è´¨é‡æ£€æŸ¥"]
            P3_D4[/"validate_trace.py"/]
            P3_D5[/"check_naming.py"/]
            P3_S --- P3_D1 & P3_D2
            P3_D1 & P3_D2 --- P3_M
            P3_M --- P3_D3
            P3_D3 --- P3_E
            P3_E --- P3_D4 & P3_D5
        end

        subgraph P4["Gate4 å‘å¸ƒ"]
            direction TB
            P4_S["â‘  ç‰ˆæœ¬å‘å¸ƒ"]
            P4_D1[/"rules_release.md"/]
            P4_D2[/"flow_release.md"/]
            P4_M["â‘¡ éªŒæ”¶é—­ç¯"]
            P4_D3[/"calculate_score.py"/]
            P4_E["â‘¢ è¿­ä»£å¤ç›˜"]
            P4_D4[/"ReleaseNote/"/]
            P4_S --- P4_D1 & P4_D2
            P4_D1 & P4_D2 --- P4_M
            P4_M --- P4_D3
            P4_D3 --- P4_E
            P4_E --- P4_D4
        end

        P1 ==> P2 ==> P3 ==> P4
    end

    %% è¿­ä»£é—­ç¯
    P4 -.->|ğŸ”„ ä¸‹ä¸€è¿­ä»£| P1

    %% ==================== AI Pilot åä½œï¼ˆåº•éƒ¨ï¼‰ ====================
    subgraph AI_Pilot["ğŸ¤– AI Pilot åä½œ"]
        direction LR

        subgraph AI_IN["è¾“å…¥"]
            direction TB
            AI_D1[/"agent_dev_main.md"/]
            AI_D2[/"agent_release.md"/]
            AI_D3[/"system_prompt_core.md"/]
            AI_D4[/"user_prompt_*.md"/]
            AI_D1 & AI_D2 --- AI_D3
            AI_D3 --- AI_D4
        end

        subgraph AI_PROC["å¤„ç†"]
            direction TB
            AI_P1["åŠ è½½ System Prompt"]
            AI_P2["åŠ è½½ User Prompt"]
            AI_P3["AI æ‰§è¡Œä»»åŠ¡"]
            AI_P1 --- AI_P2 --- AI_P3
        end

        subgraph AI_OUT["è¾“å‡º"]
            direction TB
            AI_O1[/"FR_*.md éœ€æ±‚æ–‡æ¡£"/]
            AI_O2[/"SA_*.md æ¶æ„æ–‡æ¡£"/]
            AI_O3[/"DD_*.md è®¾è®¡æ–‡æ¡£"/]
            AI_O4[/"ä»£ç æ–‡ä»¶"/]
            AI_O5[/"TC-*.md æµ‹è¯•ç”¨ä¾‹"/]
            AI_O1 --- AI_O2 --- AI_O3 --- AI_O4 --- AI_O5
        end

        AI_IN ==> AI_PROC ==> AI_OUT
    end

    %% ==================== å±‚çº§è¿æ¥ ====================
    Role --> Legend
    Legend --> Init
    Init --> Phases
    Phases --> AI_Pilot

    %% ==================== è¿çº¿æ ·å¼ï¼ˆé»‘è‰²ï¼‰ ====================
    linkStyle default stroke:#333,stroke-width:2px

    %% ==================== æ ·å¼å®šä¹‰ ====================
    %% æ¡†æ¶æ ·å¼ï¼ˆæ‰€æœ‰å¤§æ¡†ç»Ÿä¸€èƒŒæ™¯è‰²ï¼Œè¿çº¿é»‘è‰²ï¼‰
    classDef frameStyle fill:#fafafa,stroke:#424242,stroke-width:2px,color:#000
    classDef stepStyle fill:#fff,stroke:#424242,stroke-width:2px,color:#000

    %% Core æ–‡ä»¶é¢œè‰²ï¼ˆä½é¥±å’Œåº¦å†·è‰²è°ƒ - ç¨³å®š/ä½é¢‘å˜æ›´ï¼‰
    classDef entryStyle fill:#eceff1,stroke:#607d8b,stroke-width:2px,color:#000
    classDef ruleStyle fill:#e8eaf6,stroke:#5c6bc0,stroke-width:2px,color:#000
    classDef workflowStyle fill:#e0f2f1,stroke:#26a69a,stroke-width:2px,color:#000
    classDef tplStyle fill:#e3f2fd,stroke:#42a5f5,stroke-width:2px,color:#000
    classDef scriptStyle fill:#ede7f6,stroke:#7e57c2,stroke-width:2px,color:#000

    %% è¿‡ç¨‹äº§ç‰©é¢œè‰²ï¼ˆé«˜é¥±å’Œåº¦æš–è‰²è°ƒ - é¡¹ç›®è¾“å‡º/é«˜é¢‘å˜æ›´ï¼‰
    classDef outputStyle fill:#fff3e0,stroke:#ff9800,stroke-width:2px,color:#000
    classDef outputHighStyle fill:#ffccbc,stroke:#ff5722,stroke-width:2px,color:#000

    %% åº”ç”¨æ ·å¼ - æ‰€æœ‰å¤§æ¡†ç»Ÿä¸€
    class Role,Legend,LG1,LG2,Init,Phases,P1,P2,P3,P4,AI_Pilot,AI_IN,AI_PROC,AI_OUT frameStyle
    class P1_S,P2_S,P2_M,P2_E,P3_S,P3_M,P3_E,P4_S,P4_M,P4_E stepStyle
    class AI_P1,AI_P2,AI_P3 stepStyle
    class R1,R2,R3,R4 stepStyle
    class I1,I2 stepStyle

    %% å›¾ä¾‹é¢œè‰²
    class L1 entryStyle
    class L2 ruleStyle
    class L3 workflowStyle
    class L4 tplStyle
    class L5 scriptStyle
    class L6 outputStyle

    %% Init: Entry(çº¢) + Scripts(ç´«)
    class I_D1,I_D2 entryStyle
    class I_D3 scriptStyle

    %% Gate1 è§„åˆ’: Workflow(ç»¿) + Entry(çº¢)
    class P1_D1 workflowStyle
    class P1_D2 entryStyle

    %% Gate2: Entry(çº¢) + Templates(è“) + Rules(é»„)
    class P2_D1 entryStyle
    class P2_D2,P2_D3,P2_D4 tplStyle
    class P2_D5 ruleStyle

    %% Gate3: Rules(é»„) + Workflow(ç»¿) + Templates(è“) + Scripts(ç´«)
    class P3_D1 ruleStyle
    class P3_D2 workflowStyle
    class P3_D3 tplStyle
    class P3_D4,P3_D5 scriptStyle

    %% Gate4: Rules(é»„) + Workflow(ç»¿) + Scripts(ç´«) + Output(æ©™)
    class P4_D1 ruleStyle
    class P4_D2 workflowStyle
    class P4_D3 scriptStyle
    class P4_D4 outputStyle

    %% AI Pilot: è¾“å…¥(Coreæ–‡ä»¶) + è¾“å‡º(è¿‡ç¨‹äº§ç‰©-é«˜é¥±å’Œæš–è‰²)
    class AI_D1,AI_D2 ruleStyle
    class AI_D3,AI_D4 tplStyle
    class AI_O1,AI_O2,AI_O3 outputStyle
    class AI_O4,AI_O5 outputHighStyle
