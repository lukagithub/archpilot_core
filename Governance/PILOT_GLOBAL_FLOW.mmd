%% ========================================
%% ArchPilot Core å…¨å±€ Pilot æµç¨‹å›¾
%% è§’è‰²ï¼šç³»ç»Ÿæ¶æ„å¸ˆ / è½¯ä»¶æ¶æ„å·¥ç¨‹å¸ˆ
%% è¯´æ˜ï¼šå±•ç¤ºå¦‚ä½•ä½¿ç”¨æ•´ä¸ªå·¥ç¨‹çš„æ–‡æ¡£èµ„äº§æ¨è¿›é¡¹ç›®è¿­ä»£
%% ========================================

flowchart TB
    %% ==================== è§’è‰²å…¥å£ ====================
    subgraph Role["ğŸ‘¤ ç³»ç»Ÿ/è½¯ä»¶æ¶æ„å·¥ç¨‹å¸ˆ"]
        direction LR
        R1["ğŸ›ï¸ æ¶æ„è®¾è®¡"] ~~~ R2["ğŸ’» å¼€å‘æŒ‡å¯¼"] ~~~ R3["ğŸ” è´¨é‡æŠŠæ§"] ~~~ R4["ğŸš€ ç‰ˆæœ¬å‘å¸ƒ"]
    end

    %% ==================== å›¾ä¾‹ï¼ˆæ–‡æ¡£ç»´åº¦é¢œè‰²ï¼‰ ====================
    subgraph Legend["ğŸ“š æ–‡æ¡£é“¾/è¿‡ç¨‹äº§ç‰©"]
        direction LR
        L1[/"Entry å…¥å£"/]
        L2[/"Rules è§„åˆ™"/]
        L3[/"Workflow å·¥ä½œæµ"/]
        L4[/"Templates æ¨¡æ¿"/]
        L5[/"Scripts è„šæœ¬"/]
        L6[/"Output äº§å‡º"/]
        L1 ~~~ L2 ~~~ L3 ~~~ L4 ~~~ L5 ~~~ L6
    end

    %% ==================== Pilot è¿­ä»£å‘¨æœŸï¼ˆæ ¸å¿ƒï¼‰ ====================
    subgraph Phases["ğŸ“… åŸºäº ArchPilot Core çš„è¿­ä»£è¿‡ç¨‹"]
        direction LR

        subgraph P1["Gate1 å¯åŠ¨"]
            direction TB
            P1_S["â‘  ç†è§£æ¡†æ¶"]
            P1_D1[/"README.md"/]
            P1_D2[/"QUICK_START.md"/]
            P1_M["â‘¡ éƒ¨ç½²é¡¹ç›®"]
            P1_D3[/"deploy_project.sh"/]
            P1_E["â‘¢ è§„åˆ’è¿­ä»£"]
            P1_D4[/"flow_planning.md"/]
            P1_S --- P1_D1 & P1_D2
            P1_D1 & P1_D2 --- P1_M
            P1_M --- P1_D3
            P1_D3 --- P1_E
            P1_E --- P1_D4
        end

        subgraph P2["Gate2 è®¾è®¡"]
            direction TB
            P2_S["â‘  L1 éœ€æ±‚"]
            P2_D1[/"ARCHITECTURE_DEFINITION.md"/]
            P2_D2[/"requirement_template.md"/]
            P2_M["â‘¡ L2 æ¶æ„"]
            P2_D3[/"architecture_template.md"/]
            P2_E["â‘¢ L3 è®¾è®¡"]
            P2_D4[/"design_template.md"/]
            P2_D5[/"rules_naming.md"/]
            P2_S --- P2_D1 & P2_D2
            P2_D1 & P2_D2 --- P2_M
            P2_M --- P2_D3
            P2_D3 --- P2_E
            P2_E --- P2_D4 & P2_D5
        end

        subgraph P3["Gate3 å®ç°"]
            direction TB
            P3_S["â‘  L4 ä»£ç "]
            P3_D1[/"rules_coding.md"/]
            P3_D2[/"flow_implement.md"/]
            P3_M["â‘¡ L5 æµ‹è¯•"]
            P3_D3[/"testcase_template.md"/]
            P3_E["â‘¢ è´¨é‡æ£€æŸ¥"]
            P3_D4[/"validate_trace.py"/]
            P3_D5[/"check_naming.py"/]
            P3_S --- P3_D1 & P3_D2
            P3_D1 & P3_D2 --- P3_M
            P3_M --- P3_D3
            P3_D3 --- P3_E
            P3_E --- P3_D4 & P3_D5
        end

        subgraph P4["Gate4 å‘å¸ƒ"]
            direction TB
            P4_S["â‘  ç‰ˆæœ¬å‘å¸ƒ"]
            P4_D1[/"rules_release.md"/]
            P4_D2[/"flow_release.md"/]
            P4_M["â‘¡ éªŒæ”¶é—­ç¯"]
            P4_D3[/"calculate_score.py"/]
            P4_E["â‘¢ è¿­ä»£å¤ç›˜"]
            P4_D4[/"ReleaseNote/"/]
            P4_S --- P4_D1 & P4_D2
            P4_D1 & P4_D2 --- P4_M
            P4_M --- P4_D3
            P4_D3 --- P4_E
            P4_E --- P4_D4
        end

        P1 ==> P2 ==> P3 ==> P4
    end

    %% è¿­ä»£é—­ç¯
    P4 -.->|ğŸ”„ ä¸‹ä¸€è¿­ä»£| P1

    %% ==================== AI Pilot åä½œï¼ˆåº•éƒ¨ï¼‰ ====================
    subgraph AI_Pilot["ğŸ¤– AI Pilot åä½œ"]
        direction LR

        subgraph AI_IN["è¾“å…¥"]
            direction TB
            AI_D1[/"agent_dev_main.md"/]
            AI_D2[/"agent_release.md"/]
            AI_D3[/"system_prompt_core.md"/]
            AI_D4[/"user_prompt_*.md"/]
            AI_D1 & AI_D2 --- AI_D3
            AI_D3 --- AI_D4
        end

        subgraph AI_PROC["å¤„ç†"]
            direction TB
            AI_P1["åŠ è½½ System Prompt"]
            AI_P2["åŠ è½½ User Prompt"]
            AI_P3["AI æ‰§è¡Œä»»åŠ¡"]
            AI_P1 --- AI_P2 --- AI_P3
        end

        subgraph AI_OUT["è¾“å‡º"]
            direction TB
            AI_O1[/"FR_*.md éœ€æ±‚æ–‡æ¡£"/]
            AI_O2[/"SA_*.md æ¶æ„æ–‡æ¡£"/]
            AI_O3[/"DD_*.md è®¾è®¡æ–‡æ¡£"/]
            AI_O4[/"ä»£ç æ–‡ä»¶"/]
            AI_O5[/"TC-*.md æµ‹è¯•ç”¨ä¾‹"/]
            AI_O1 --- AI_O2 --- AI_O3 --- AI_O4 --- AI_O5
        end

        AI_IN ==> AI_PROC ==> AI_OUT
    end

    %% ==================== å±‚çº§è¿æ¥ ====================
    Role --> Legend
    Legend --> Phases
    Phases --> AI_Pilot

    %% ==================== æ ·å¼å®šä¹‰ ====================
    %% æ¡†æ¶æ ·å¼ï¼ˆæ‰€æœ‰å¤§æ¡†ç»Ÿä¸€èƒŒæ™¯è‰²ï¼‰
    classDef frameStyle fill:#fafafa,stroke:#616161,stroke-width:2px,color:#000
    classDef stepStyle fill:#fff,stroke:#616161,stroke-width:2px,color:#000

    %% æ–‡æ¡£ç»´åº¦é¢œè‰²ï¼ˆä»…ç”¨äºæ–‡æ¡£èŠ‚ç‚¹ï¼‰
    classDef entryStyle fill:#ffcdd2,stroke:#c62828,stroke-width:2px,color:#000
    classDef ruleStyle fill:#fff9c4,stroke:#f57f17,stroke-width:2px,color:#000
    classDef workflowStyle fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px,color:#000
    classDef tplStyle fill:#bbdefb,stroke:#1565c0,stroke-width:2px,color:#000
    classDef scriptStyle fill:#e1bee7,stroke:#7b1fa2,stroke-width:2px,color:#000
    classDef outputStyle fill:#ffe0b2,stroke:#ef6c00,stroke-width:2px,color:#000

    %% åº”ç”¨æ ·å¼ - æ‰€æœ‰å¤§æ¡†ç»Ÿä¸€
    class Role,Legend,Phases,P1,P2,P3,P4,AI_Pilot,AI_IN,AI_PROC,AI_OUT frameStyle
    class P1_S,P1_M,P1_E,P2_S,P2_M,P2_E,P3_S,P3_M,P3_E,P4_S,P4_M,P4_E stepStyle
    class AI_P1,AI_P2,AI_P3 stepStyle

    %% å›¾ä¾‹é¢œè‰²
    class L1 entryStyle
    class L2 ruleStyle
    class L3 workflowStyle
    class L4 tplStyle
    class L5 scriptStyle
    class L6 outputStyle

    %% Gate1: Entry(çº¢) + Scripts(ç´«) + Workflow(ç»¿)
    class P1_D1,P1_D2 entryStyle
    class P1_D3 scriptStyle
    class P1_D4 workflowStyle

    %% Gate2: Entry(çº¢) + Templates(è“) + Rules(é»„)
    class P2_D1 entryStyle
    class P2_D2,P2_D3,P2_D4 tplStyle
    class P2_D5 ruleStyle

    %% Gate3: Rules(é»„) + Workflow(ç»¿) + Templates(è“) + Scripts(ç´«)
    class P3_D1 ruleStyle
    class P3_D2 workflowStyle
    class P3_D3 tplStyle
    class P3_D4,P3_D5 scriptStyle

    %% Gate4: Rules(é»„) + Workflow(ç»¿) + Scripts(ç´«) + Output(æ©™)
    class P4_D1 ruleStyle
    class P4_D2 workflowStyle
    class P4_D3 scriptStyle
    class P4_D4 outputStyle

    %% AI Pilot: è¾“å…¥(Agents=è§„åˆ™è‰², Prompts=æ¨¡æ¿è‰²) + è¾“å‡º(äº§å‡ºè‰²)
    class AI_D1,AI_D2 ruleStyle
    class AI_D3,AI_D4 tplStyle
    class AI_O1,AI_O2,AI_O3,AI_O4,AI_O5 outputStyle
