# AI 变更保护与执行规则

**文档版本**: v1.0.0  
**最后更新**: 2026-02-01  
**适用范围**: 基于本框架的所有 AI 辅助开发项目

> 本文档定义了 AI 在项目中执行任务时必须遵循的变更保护机制和执行规则。

---

## 1. 核心规则声明

### 1.1 变更保护机制

所有受保护文件必须在头部包含以下标准声明：

```markdown
> **⚠️ AI 变更保护声明**
>
> 本文件受 AI 变更保护：
> 1. AI 如需修改此文件，必须输出详细的变更理由
> 2. 必须经过人工确认后才能进行任何修改
> 3. 严格禁止 AI 自动修改此文件
>
> **说明**: 该约束确保本文件的修改必须经过人工审查和批准。
```

### 1.2 文件格式适配

| 文件类型 | 保护声明格式 |
|----------|-------------|
| Markdown (.md) | 使用 `>` 引用格式 |
| Mermaid (.mmd) | 使用 `%%` 注释格式 |
| Python (.py) | 使用 `"""` 或 `#` 注释 |
| JavaScript/TypeScript | 使用 `/* */` 或 `//` 注释 |
| YAML/JSON | 使用 `#` 注释（YAML）或外部文档说明 |
| 其他代码文件 | 使用对应语言的注释格式 |

### 1.3 不可移除规则

**重要**：一旦在文件头部插入 AI 变更保护声明：
- ✅ 只有人工确认后才能移除
- ❌ AI 绝对不能自动移除保护声明
- ✅ 移除必须记录原因和批准人

---

## 2. 默认保护范围

### 2.1 强制保护文件

以下文件/目录**默认受保护**，AI 不得自动修改：

| 路径 | 保护级别 | 说明 |
|------|----------|------|
| `Governance/` | 强制保护 | 所有治理文档 |
| `ARCHITECTURE_DEFINITION.md` | 强制保护 | 架构权威定义 |
| `GLOSSARY.md` | 强制保护 | 术语标准表 |
| `rules/*.md` | 强制保护 | 所有规则文件 |
| `VERSION` | 强制保护 | 版本文件 |

### 2.2 可选保护维度

项目可根据需要在以下维度选择启用保护：

#### 按追溯层级
- [ ] L1 需求层（FR_*.md）
- [ ] L2 架构层（SA_*.md）
- [ ] L3 设计层（DD_*.md）
- [ ] L4 实现层（核心代码文件）
- [ ] L5 验证层（测试文档）

#### 按文件类型
- [ ] 核心架构文档
- [ ] 详细设计文档
- [ ] 核心代码文件
- [ ] 配置模板文件
- [ ] 工具脚本文件

#### 按保护优先级
- [ ] 最高优先级（必须保护）
- [ ] 高优先级
- [ ] 中优先级
- [ ] 低优先级

---

## 3. AI 任务执行规则

### 3.1 任务委托规则

**规则 A1：任务类型识别**
- AI 必须首先识别任务涉及的层级（L1-L5）和子系统
- 根据任务类型加载对应的规则文件

**规则 A2：规则优先读取**
- 执行任务前必须读取 `GOVERNANCE_OVERVIEW.md`
- 加载与任务相关的 `rules/*.md` 文件
- 理解并遵循规则约束

**规则 A3：变更保护尊重**
- 对于受保护文件，AI 必须：
  1. 输出详细的变更理由
  2. 等待人工确认
  3. 获得明确授权后才能修改

**规则 A4：文档作者签署规范**
- AI 生成的所有文档，**文档编制人/作者**字段默认签署为 **nobody**
- 此规则适用于以下场景：
  1. 新建文档时的 `文档编制人` / `Author` / `owner` 字段
  2. YAML 元数据中的 `owner` 字段
  3. 代码注释中的 `@author` 标签
  4. 文档末尾的签名区域
- 示例格式：
  ```
  **文档编制人**: nobody
  **审核人**: 待定
  **批准人**: 待定
  ```
- 如用户明确指定其他作者，则以用户指定为准

### 3.2 执行流程标准化

```
1. 任务接收
   ├─ 解析任务内容
   └─ 识别任务类型
       ↓
2. 规则识别
   ├─ 读取 GOVERNANCE_OVERVIEW.md
   ├─ 加载相关规则文件
   └─ 理解保护约束
       ↓
3. 约束检查
   ├─ 检查目标文件是否受保护
   ├─ 验证操作是否符合规则
   └─ 如有冲突则请求人工确认
       ↓
4. 任务执行
   ├─ 在规则约束下执行任务
   ├─ 保持追溯关系完整
   └─ 使用标准命名和格式
       ↓
5. 追溯验证
   ├─ 检查 traces_from/traces_to
   ├─ 验证层级关系正确
   └─ 确保元数据完整
       ↓
6. 结果记录
   ├─ 总结规则遵守情况
   └─ 报告潜在问题
```

### 3.3 验证与审计

- AI 应在适当位置记录规则检查日志
- 治理委员会可通过检查日志验证规则执行情况
- 违反规则的任务执行结果视为无效，必须回滚

---

## 4. 会话级授权机制

### 4.1 临时授权

在特定会话中，用户可以授权 AI 修改受保护文件：

```markdown
**会话授权声明**：
用户已明确授权 AI 在本次会话中修改 `Governance/` 下文件，
用于 [具体目的]；该授权仅对本次会话有效，
后续默认仍按保护规则执行。
```

### 4.2 授权范围

| 授权级别 | 范围 | 说明 |
|----------|------|------|
| 单文件授权 | 指定单个文件 | 仅授权修改特定文件 |
| 目录授权 | 指定目录 | 授权修改目录下所有文件 |
| 会话授权 | 当前会话 | 授权在会话内的所有操作 |
| 持久授权 | 跨会话 | 需在配置文件中明确声明 |

---

## 5. 规则冲突处理

### 5.1 冲突优先级

当规则发生冲突时，按以下优先级处理：

1. **人工明确指令** > 一切规则
2. **变更保护声明** > 一般执行规则
3. **核心定义层文档** > 规则标准层文档
4. **规则标准层文档** > 检查执行层文档

### 5.2 冲突报告

当 AI 检测到规则冲突时，必须：
1. 暂停执行
2. 报告冲突详情
3. 列出各规则来源
4. 请求人工决策

---

## 6. 响应要求

AI 在执行任务时的响应必须包含：

### 6.1 任务开始前

```markdown
**规则加载情况**：
- ✅ 已读取 GOVERNANCE_OVERVIEW.md
- ✅ 已加载 rules/rules_xxx.md
- ⚠️ 目标文件受保护，需要确认

**将应用的规则**：
1. [规则名称] - [简述]
2. [规则名称] - [简述]
```

### 6.2 任务执行中

- 引用具体规则条目作为操作依据
- 说明追溯关系的维护方式

### 6.3 任务完成后

```markdown
**规则遵守情况总结**：
- ✅ [规则1] - 已遵守
- ✅ [规则2] - 已遵守
- ⚠️ [规则3] - 豁免（理由：xxx）

**追溯关系更新**：
- 新增/修改的文档已正确设置 traces_from/traces_to
```

---

## 7. 关联文档

- `GOVERNANCE_OVERVIEW.md` - 治理体系入口
- `ARCHITECTURE_DEFINITION.md` - 架构权威定义
- `../Guides/AI_Development_Guide.md` - AI 开发指南

---

## 8. 生效时间

本规则自发布之日起生效，适用于所有 AI 会话。

