%%{init: {'theme': 'base', 'themeVariables': { 'lineColor': '#000000', 'arrowheadColor': '#000000' }}}%%
%% ========================================
%% ArchPilot Core å…¨å±€ Pilot æµç¨‹å›¾
%% è§’è‰²ï¼šç³»ç»Ÿæ¶æ„å¸ˆ / è½¯ä»¶æ¶æ„å·¥ç¨‹å¸ˆ
%% è¯´æ˜ï¼šå±•ç¤ºå¦‚ä½•ä½¿ç”¨æ•´ä¸ªå·¥ç¨‹çš„æ–‡æ¡£èµ„äº§æ¨è¿›é¡¹ç›®è¿­ä»£
%% ========================================

flowchart TB
    %% ==================== é¡¶éƒ¨ï¼šè§’è‰² + æ–‡æ¡£é“¾ å¹¶åˆ— ====================
    subgraph TopSection[" "]
        direction LR

        subgraph Role["ğŸ‘¤ ç³»ç»Ÿ/è½¯ä»¶æ¶æ„å·¥ç¨‹å¸ˆ"]
            direction TB
            R1["ğŸ›ï¸ æ¶æ„è®¾è®¡"]
            R2["ğŸ’» å¼€å‘æŒ‡å¯¼"]
            R3["ğŸ” è´¨é‡æŠŠæ§"]
            R4["ğŸš€ ç‰ˆæœ¬å‘å¸ƒ"]
            R1 ~~~ R2 ~~~ R3 ~~~ R4
        end

        subgraph Legend["ğŸ“š æ–‡æ¡£é“¾/è¿‡ç¨‹äº§ç‰©"]
            direction TB
            subgraph LG1["Core æ¡†æ¶æ–‡ä»¶ï¼ˆæŠ½è±¡/ç¨³å®šï¼‰"]
                direction LR
                L1[/"Entry: UPPER_CASE"/] ~~~ L2[/"Rules: rules_"/] ~~~ L3[/"Workflow: flow_"/] ~~~ L4[/"Templates: tpl_"/] ~~~ L5[/"Checklists: chk_"/] ~~~ L5b[/"Scripts: *.py|*.sh"/]
            end
            subgraph LG2["è¿‡ç¨‹äº§ç‰©ï¼ˆå…·ä½“/é¡¹ç›®è¾“å‡ºï¼‰"]
                direction LR
                L6[/"L1: FR_ éœ€æ±‚"/] ~~~ L7[/"L2: SA_ æ¶æ„"/] ~~~ L8[/"L3: DD_ è®¾è®¡"/] ~~~ L9[/"L4: ä»£ç "/] ~~~ L10[/"L5: TC_ æµ‹è¯•"/]
            end
            LG1 --> LG2
        end

        Role ~~~ Legend
    end

    %% ==================== é¡¹ç›®åˆå§‹åŒ–ï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰ ====================
    subgraph Init["ğŸš€ é¡¹ç›®åˆå§‹åŒ–ï¼ˆéƒ¨ç½²æ ¸å¿ƒæ¡†æ¶æ–‡ä»¶ï¼‰"]
        direction LR
        I1["â‘  ç†è§£æ ¸å¿ƒæ¡†æ¶"]
        I_D1[/"README.md"/]
        I_D2[/"QUICK_START.md"/]
        I2["â‘¡ éƒ¨ç½²åˆ°é¡¹ç›®"]
        I_D3[/"deploy_project.sh"/]
        I_D1 --> I1
        I_D2 --> I1
        I1 --> I2
        I_D3 --> I2
    end

    %% ==================== Pilot è¿­ä»£å‘¨æœŸï¼ˆæ ¸å¿ƒï¼‰ ====================
    subgraph Phases["ğŸ“… åŸºäº ArchPilot Core çš„è¿­ä»£è¿‡ç¨‹"]
        direction LR

        subgraph P1["Gate1 è§„åˆ’"]
            direction TB
            P1_S["â‘  è§„åˆ’/å¾®è°ƒè¿­ä»£"]
            P1_D1[/"flow_planning.md"/]
            P1_D2[/"ARCHITECTURE_DEFINITION.md"/]
            P1_D3[/"GLOSSARY.md"/]
            P1_D2 --> P1_D1
            P1_D3 --> P1_D1
            P1_D1 --> P1_S
        end

        subgraph P2["Gate2 è®¾è®¡"]
            direction TB
            P2_S["â‘  L1 éœ€æ±‚"]
            P2_D1[/"tpl_requirement.md"/]
            P2_D2[/"rules_naming.md"/]
            P2_O1[/"FR_*.md"/]
            P2_M["â‘¡ L2 æ¶æ„"]
            P2_D3[/"tpl_architecture.md"/]
            P2_O2[/"SA_*.md"/]
            P2_E["â‘¢ L3 è®¾è®¡"]
            P2_D4[/"tpl_design.md"/]
            P2_O3[/"DD_*.md"/]
            P2_D1 --> P2_S
            P2_D2 --> P2_S
            P2_S --> P2_O1
            P2_O1 --> P2_M
            P2_D3 --> P2_M
            P2_M --> P2_O2
            P2_O2 --> P2_E
            P2_D4 --> P2_E
            P2_E --> P2_O3
        end

        subgraph P3["Gate3 å®ç°"]
            direction TB
            P3_S["â‘  L4 ä»£ç "]
            P3_D1[/"rules_coding.md"/]
            P3_D2[/"flow_implement.md"/]
            P3_D6[/"chk_dev.md"/]
            P3_O1[/"ä»£ç æ–‡ä»¶.cpp/.hpp"/]
            P3_M["â‘¡ L5 æµ‹è¯•"]
            P3_D3[/"tpl_testcase.md"/]
            P3_O2[/"TC_*.md"/]
            P3_E["â‘¢ è´¨é‡æ£€æŸ¥"]
            P3_D4[/"validate_trace.py"/]
            P3_D5[/"check_naming.py"/]
            P3_D1 --> P3_S
            P3_D2 --> P3_S
            P3_D6 --> P3_S
            P3_S --> P3_O1
            P3_O1 --> P3_M
            P3_D3 --> P3_M
            P3_M --> P3_O2
            P3_O2 --> P3_E
            P3_D4 --> P3_E
            P3_D5 --> P3_E
        end

        subgraph P4["Gate4 å‘å¸ƒ"]
            direction TB
            P4_S["â‘  ç‰ˆæœ¬å‘å¸ƒ"]
            P4_D1[/"rules_release.md"/]
            P4_D2[/"flow_release.md"/]
            P4_D6[/"chk_release.md"/]
            P4_M["â‘¡ éªŒæ”¶é—­ç¯"]
            P4_D3[/"calculate_score.py"/]
            P4_O1[/"è´¨é‡è¯„åˆ†æŠ¥å‘Š"/]
            P4_E["â‘¢ è¿­ä»£å¤ç›˜"]
            P4_D4[/"ReleaseNote/"/]
            P4_D1 --> P4_S
            P4_D2 --> P4_S
            P4_D6 --> P4_S
            P4_S --> P4_M
            P4_D3 --> P4_M
            P4_M --> P4_O1
            P4_O1 --> P4_E
            P4_E --> P4_D4
        end

        P1 ==> P2 ==> P3 ==> P4
    end

    %% è¿­ä»£é—­ç¯
    P4 -.->|ğŸ”„ ä¸‹ä¸€è¿­ä»£| P1

    %% ==================== AI Pilot åä½œï¼ˆåº•éƒ¨æ”¯æ’‘ï¼‰ ====================
    subgraph AI_Pilot["ğŸ¤– AI Pilot åä½œï¼ˆè´¯ç©¿æ•´ä¸ªè¿­ä»£è¿‡ç¨‹ï¼‰"]
        direction LR

        subgraph AI_IN["è¾“å…¥"]
            direction TB
            AI_D1[/"agent_dev_main.md"/]
            AI_D2[/"agent_release.md"/]
            AI_D3[/"system_prompt_core.md"/]
            AI_D4[/"user_prompt_*.md"/]
        end

        subgraph AI_PROC["å¤„ç†"]
            direction TB
            AI_P1["åŠ è½½ System Prompt"]
            AI_P2["åŠ è½½ User Prompt"]
            AI_P3["AI æ‰§è¡Œä»»åŠ¡"]
        end

        subgraph AI_OUT["è¾“å‡º"]
            direction TB
            AI_O1[/"FR_*.md éœ€æ±‚æ–‡æ¡£"/]
            AI_O2[/"SA_*.md æ¶æ„æ–‡æ¡£"/]
            AI_O3[/"DD_*.md è®¾è®¡æ–‡æ¡£"/]
            AI_O4[/"ä»£ç æ–‡ä»¶"/]
            AI_O5[/"TC_*.md æµ‹è¯•ç”¨ä¾‹"/]
        end

        AI_D1 --> AI_D3
        AI_D2 --> AI_D3
        AI_D3 --> AI_D4
        AI_D4 --> AI_P1
        AI_P1 --> AI_P2
        AI_P2 --> AI_P3
        AI_P3 --> AI_O1
        AI_O1 --> AI_O2
        AI_O2 --> AI_O3
        AI_O3 --> AI_O4
        AI_O4 --> AI_O5
    end

    %% ==================== å±‚çº§è¿æ¥ ====================
    TopSection --> Init
    Init --> Phases
    Phases --> AI_Pilot

    %% ==================== è¿çº¿æ ·å¼ï¼ˆé»‘è‰²ï¼Œå¢å¼ºå¯è§åº¦ï¼‰ ====================
    linkStyle default stroke:#000,stroke-width:2px

    %% ==================== æ ·å¼å®šä¹‰ ====================
    %% æ¡†æ¶æ ·å¼ï¼ˆæ‰€æœ‰å¤§æ¡†ç»Ÿä¸€èƒŒæ™¯è‰²ï¼Œè¿çº¿é»‘è‰²ï¼‰
    classDef frameStyle fill:#fafafa,stroke:#424242,stroke-width:2px,color:#000
    classDef stepStyle fill:#fff,stroke:#424242,stroke-width:2px,color:#000

    %% Core æ–‡ä»¶é¢œè‰²ï¼ˆä½é¥±å’Œåº¦å†·è‰²è°ƒ - ç¨³å®š/ä½é¢‘å˜æ›´ï¼‰
    classDef entryStyle fill:#f3e5f5,stroke:#8e24aa,stroke-width:2px,color:#000
    classDef ruleStyle fill:#fce4ec,stroke:#c2185b,stroke-width:2px,color:#000
    classDef workflowStyle fill:#e0f2f1,stroke:#00897b,stroke-width:2px,color:#000
    classDef tplStyle fill:#eceff1,stroke:#546e7a,stroke-width:2px,color:#000
    classDef chkStyle fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,color:#000
    classDef scriptStyle fill:#e8eaf6,stroke:#3949ab,stroke-width:2px,color:#000

    %% è¿‡ç¨‹äº§ç‰©é¢œè‰²ï¼ˆé«˜é¥±å’Œåº¦æš–è‰²è°ƒ - é¡¹ç›®è¾“å‡º/é«˜é¢‘å˜æ›´ï¼‰
    classDef outputStyle fill:#fff3e0,stroke:#ff9800,stroke-width:2px,color:#000
    classDef outputHighStyle fill:#ffccbc,stroke:#ff5722,stroke-width:2px,color:#000

    %% åº”ç”¨æ ·å¼ - æ‰€æœ‰å¤§æ¡†ç»Ÿä¸€
    class TopSection,Role,Legend,LG1,LG2,Init,Phases,P1,P2,P3,P4,AI_Pilot,AI_IN,AI_PROC,AI_OUT frameStyle
    class P1_S,P2_S,P2_M,P2_E,P3_S,P3_M,P3_E,P4_S,P4_M,P4_E stepStyle
    class AI_P1,AI_P2,AI_P3 stepStyle
    class R1,R2,R3,R4 stepStyle
    class I1,I2 stepStyle

    %% å›¾ä¾‹é¢œè‰²
    class L1 entryStyle
    class L2 ruleStyle
    class L3 workflowStyle
    class L4 tplStyle
    class L5 chkStyle
    class L5b scriptStyle
    class L6,L7,L8 outputStyle
    class L9,L10 outputHighStyle

    %% Init: Entry(çº¢) + Scripts(ç´«)
    class I_D1,I_D2 entryStyle
    class I_D3 scriptStyle

    %% Gate1 è§„åˆ’: Workflow(ç»¿) + Entry(ç°)
    class P1_D1 workflowStyle
    class P1_D2,P1_D3 entryStyle

    %% Gate2: Templates(è“) + Rules(é›è“) + Output(æ©™)
    class P2_D1,P2_D3,P2_D4 tplStyle
    class P2_D2 ruleStyle
    class P2_O1,P2_O2,P2_O3 outputStyle

    %% Gate3: Rules(é›è“) + Workflow(ç»¿) + Checklists(ç²‰) + Templates(è“) + Scripts(ç´«) + Output(æ©™)
    class P3_D1 ruleStyle
    class P3_D2 workflowStyle
    class P3_D6 chkStyle
    class P3_D3 tplStyle
    class P3_D4,P3_D5 scriptStyle
    class P3_O1,P3_O2 outputHighStyle

    %% Gate4: Rules(é›è“) + Workflow(ç»¿) + Checklists(ç²‰) + Scripts(ç´«) + Output(æ©™)
    class P4_D1 ruleStyle
    class P4_D2 workflowStyle
    class P4_D6 chkStyle
    class P4_D3 scriptStyle
    class P4_D4,P4_O1 outputStyle

    %% AI Pilot: è¾“å…¥(Coreæ–‡ä»¶) + è¾“å‡º(è¿‡ç¨‹äº§ç‰©-é«˜é¥±å’Œæš–è‰²)
    class AI_D1,AI_D2 ruleStyle
    class AI_D3,AI_D4 tplStyle
    class AI_P1,AI_P2,AI_P3 stepStyle
    class AI_O1,AI_O2,AI_O3 outputStyle
    class AI_O4,AI_O5 outputHighStyle
