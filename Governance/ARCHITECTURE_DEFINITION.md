# ArchPilot Core - L1-L5 架构权威定义

**文档版本**: v1.0.0  
**最后更新**: 2026-02-01  
**适用范围**: 基于 ArchPilot Core 框架的所有项目  
**引用自**: `Governance/GOVERNANCE_OVERVIEW.md`

> 本文档是 L1-L5 层级的唯一权威定义，所有治理文档、检查脚本与自动化流程必须以此为基准。

---

## 1. 层级职责与产出物

| 层级 | 中文名称 | 核心职责 | 目录路径（示例） | 文件前缀 | 关键产出 |
|------|----------|----------|-----------------|----------|----------|
| **L1** | 需求层 | 定义做什么、为什么做 | `L1_Requirements/` | `FR_`, `US_`, `AC_` | 需求说明书、验收条件、业务指标 |
| **L2** | 架构层 | 定义如何组织系统 | `L2_Architecture/` | `SA_`, `ARCH_`, `ADR_` | 系统架构、接口矩阵、模块边界 |
| **L3** | 设计层 | 定义如何实现 | `L3_DetailDesign/` | `DD_`, `IF_` | 详细设计、接口契约、数据结构 |
| **L4** | 实现层 | 编码、配置、脚本实现 | `L4_Implementation/` | `API_`, `IMPL_`, `MOD_` | 代码、API 文档、示例 |
| **L5** | 验证层 | 测试与验证 | `L5_Verification/` | `TC-`, `TR-` | 测试计划、用例、报告 |

**执行原则**:
- 任意下层文档/实现必须追溯到一个或多个上层 artefact
- 任何层的缺失会拉低质量评分
- 目录和前缀如需新增，必须先更新本文件

---

## 2. 追溯关系与元数据

### 2.1 标准追溯链

```
FR_xxx (L1)
  ↓ traces_to
SA_xxx (L2)
  ↓ traces_to
DD_xxx (L3)
  ↓ traces_to
Implementation Artefacts (L4)
  ↓ verified_by
TC-xxx / TR-xxx (L5)
  ↓ closes
FR_xxx (闭环)
```

### 2.2 元数据字段（所有 Markdown 文档必须具备）

```yaml
---
id: FR_core_001              # 文档唯一标识符
layer: L1                    # 所属层级（L1~L5）
status: approved             # 状态（draft|review|approved|deprecated）
version: v1.0.0              # 版本号
traces_from: []              # 上游 ID 列表
traces_to: [SA_core_001]     # 下游实现
related: [FR_core_002]       # 相关文档
owner: core-team             # 责任小组
created: 2026-02-01          # 创建时间
updated: 2026-02-01          # 更新时间
---
```

**字段说明**:
- `layer` 的可选值固定为 `L1`~`L5`
- `traces_from` 与 `traces_to` 使用权威 ID 列表
- `owner` 指定责任小组，便于自动分派缺陷

### 2.3 追溯验证

| 数据源 | 验证方法 | 输出 |
|--------|----------|------|
| 文档 YAML 元数据 | 脚本解析 `traces_from`/`traces_to` | 缺失/断链报告 |
| 追溯矩阵 CSV | `validate_trace.py` | 完整性报告 |
| 代码注释 | 正则匹配 `@requirement`, `@design` | 覆盖率报告 |

---

## 3. 目录结构约束

### 3.1 标准目录

```
project_root/
├── Governance/              # 治理文档
├── L1_Requirements/         # L1 需求层
├── L2_Architecture/         # L2 架构层
├── L3_DetailDesign/         # L3 设计层
├── L4_Implementation/       # L4 实现层
│   └── src/                # 源代码
├── L5_Verification/         # L5 验证层
│   ├── unit/               # 单元测试
│   ├── integration/        # 集成测试
│   └── system/             # 系统测试
└── VERSION                  # 版本文件
```

### 3.2 约束规则

- ✅ **MUST**: 层级目录命名必须为 `L{1..5}_*` 格式
- ✅ **MUST**: 禁止在层级目录之外存放层级相关文档
- ✅ **MUST**: 文件命名必须遵循 `rules/rules_naming.md` 定义的前缀规则
- ⚠️ **SHOULD**: 每个层级目录下建议包含 `templates/` 子目录存放模板

---

## 4. 子系统定义（项目定制）

> **本节是子系统定义的唯一权威源**，其他文档应引用此处而非重复定义。
> 以下为示例子系统定义，请根据具体项目修改。

| 子系统名称 | 缩写 | 职责范围 | 依赖 |
|------------|------|----------|------|
| **核心功能** | core | 核心业务逻辑 | - |
| **数据管理** | data | 数据存储、处理、传输 | core |
| **用户界面** | ui | 用户交互界面 | core, data |
| **工具集** | util | 通用工具和辅助功能 | - |
| **平台管理** | plt | 配置、安全、扩展管理 | core |

**子系统交互原则**:
- 每个子系统有明确的职责边界
- 跨子系统交互需在 L2 架构层定义接口
- L3 详细设计可描述跨子系统组件的交互

---

## 5. 层级间依赖规则

### 5.1 合法依赖方向

```
L1 → L2 → L3 → L4 → L5
      ↑_______↓
         反馈
```

- ✅ 下层可以依赖上层（实现依赖设计）
- ✅ L5 可以反馈到任意层（测试发现问题）
- ❌ 上层不能依赖下层具体实现

### 5.2 跨层直接引用

| 场景 | 是否允许 | 说明 |
|------|----------|------|
| L1 直接引用 L4 | ❌ | 需求不能依赖具体实现 |
| L5 直接引用 L1 | ✅ | 测试验证需求 |
| L3 直接引用 L1 | ⚠️ | 允许但建议通过 L2 桥接 |

---

## 6. 应用方式

### 6.1 规范引用

- 所有规则文档在描述 L1-L5 时必须引用本文件
- 禁止在其他文档中复制本表格

### 6.2 工具基线

- 自动化脚本以本文件提供的目录和前缀为常量源
- 命名检查、追溯验证工具读取本文件配置

### 6.3 变更审批

- 修改本文件需通过治理委员会评审
- 变更后需同步更新所有受影响的下游文档

---

## 7. 关联文档

- `GOVERNANCE_OVERVIEW.md` - 治理体系入口
- `GLOSSARY.md` - 术语标准表
- `rules/rules_naming.md` - 命名规范
- `rules/rules_coding.md` - 编码规范
- `checklists/chk_dev.md` - 开发检查清单

---

**本定义自发布之日起生效，任何未按此定义编写的文档或脚本视为不合规。**

