# ArchPilot Core - AI 发布自动化指南

**版本**: v1.0.0  
**最后更新**: 2026-02-01  
**目标**: 为 AI 提供完整的版本发布自动化执行依据

---

## 一、文档目的

本指南使 AI 能够：

1. 理解项目的五层文档驱动开发（L1-L5）架构
2. 掌握版本发布的标准流程、检查项和质量评分体系
3. 自动执行从开发完成到正式发布的完整流程
4. 基于规则做出发布决策，生成发布报告

---

## 二、前置条件检查

在执行任何发布操作前，AI 必须验证：

### 2.1 规则文档完整性

| 文档路径 | 用途 | 必需 |
|----------|------|------|
| `Governance/GOVERNANCE_OVERVIEW.md` | 治理入口 | ✅ |
| `Governance/ARCHITECTURE_DEFINITION.md` | 架构定义 | ✅ |
| `Governance/rules/rules_release.md` | 发布规则 | ✅ |
| `Governance/rules/rules_tag.md` | Tag 规范 | ✅ |
| `Governance/checklists/dev_checklist.md` | 检查清单 | ✅ |

### 2.2 环境检查

```bash
# 检查版本文件
cat VERSION

# 检查 Git 状态
git status
git branch

# 检查分支（应为 main）
git branch --show-current
```

---

## 三、发布流程详解

### 3.1 步骤概览

```
1. 确定发布范围
2. 检查前置条件
3. 运行 L1-L5 一致性检查
4. 执行质量评分
5. 基于评分做出发布决策
6. 更新版本号（如需）
7. 生成发布报告
8. 创建 Git Tag
9. 验证发布结果
```

### 3.2 详细执行步骤

#### 步骤 1：确定版本号

```bash
# 读取当前版本
cat VERSION

# 分析 commit 类型，决定递增类型
git log --oneline -10

# 递增规则：
# - BREAKING CHANGE → MAJOR++
# - feat: → MINOR++
# - fix:/docs:/test: → PATCH++
```

#### 步骤 2：L1-L5 一致性检查

检查项：
- [ ] L1 需求文档存在且完整
- [ ] L2 架构设计与需求匹配
- [ ] L3 详细设计实现架构
- [ ] L4 代码遵循设计
- [ ] L5 测试覆盖需求
- [ ] 追溯链无断裂

#### 步骤 3：质量评分

**五维度评分（5分制）**：

| 维度 | 权重 | 评估内容 |
|------|------|----------|
| D1 | 20% | 文档完整性 |
| D2 | 15% | 追溯关系 |
| D3 | 30% | 功能实现 |
| D4 | 25% | 测试验证 |
| D5 | 10% | 代码质量 |

**计算公式**：
```
加权总分 = D1×0.2 + D2×0.15 + D3×0.3 + D4×0.25 + D5×0.1
```

#### 步骤 4：发布决策

| 加权总分 | 评级 | 发布类型 | 决策 |
|---------|------|----------|------|
| ≥4.5 | 优秀 | 正式版 | ✅ 推荐发布 |
| ≥4.0 | 良好 | 正式版 | ✅ 可以发布 |
| ≥3.0 | 及格 | Beta/RC | ⚠️ 有条件发布 |
| <3.0 | 不及格 | - | ❌ 禁止发布 |

#### 步骤 5：版本号更新

```bash
# 更新 VERSION 文件
echo "v1.2.3" > VERSION

# 提交更改
git add VERSION
git commit -m "chore: bump version to v1.2.3"
```

#### 步骤 6：生成发布报告

使用模板生成：
- `RELEASE_REPORT_v{VERSION}.md` - 质量评估报告
- `ReleaseNote/v{VERSION}.md` - 发布说明

#### 步骤 7：创建 Git Tag

```bash
# 准备 Tag 内容
cat > /tmp/tag_msg.txt << 'EOF'
Release v{VERSION}: {简短标题}

🚀 主要变更
- {变更1}
- {变更2}

📦 关键特性:
- {特性1}
- {特性2}

🧪 测试状态:
- 单元测试: {覆盖率}%

✅ 状态: 正式发布
EOF

# 创建 Tag
git tag -a v{VERSION} -F /tmp/tag_msg.txt

# 验证
git show v{VERSION}
```

#### 步骤 8：验证发布

- [ ] VERSION 文件已更新
- [ ] 发布报告已生成
- [ ] ReleaseNote 已生成
- [ ] Git Tag 已创建
- [ ] 所有文件已提交

---

## 四、质量评分详细标准

### 4.1 D1: 文档完整性（20%）

| 分数 | 标准 |
|------|------|
| 5.0 | 所有必需文档存在且完整规范 |
| 4.0 | 核心文档完整，少量缺失 |
| 3.0 | 主要文档存在，部分不完整 |
| 2.0 | 文档缺失较多 |
| 1.0 | 缺少大部分必需文档 |

### 4.2 D2: 追溯关系（15%）

| 分数 | 标准 |
|------|------|
| 5.0 | L1-L5 追溯链 100% 完整 |
| 4.0 | 追溯链完整度 ≥90% |
| 3.0 | 追溯链完整度 ≥70% |
| 2.0 | 追溯链完整度 ≥50% |
| 1.0 | 追溯链完整度 <50% |

### 4.3 D3: 功能实现（30%）

| 分数 | 标准 |
|------|------|
| 5.0 | 所有计划功能实现，质量优秀 |
| 4.0 | 核心功能完成，质量良好 |
| 3.0 | 主要功能完成，存在非阻断问题 |
| 2.0 | 部分功能未完成 |
| 1.0 | 关键功能未完成 |

### 4.4 D4: 测试验证（25%）

| 分数 | 标准 |
|------|------|
| 5.0 | 覆盖率 ≥85%，全部通过 |
| 4.0 | 覆盖率 ≥70%，核心通过 |
| 3.0 | 覆盖率 ≥50%，主要通过 |
| 2.0 | 覆盖率 ≥30%，存在失败 |
| 1.0 | 覆盖率 <30% |

### 4.5 D5: 代码质量（10%）

| 分数 | 标准 |
|------|------|
| 5.0 | 无静态分析问题 |
| 4.0 | 仅低优先级警告 |
| 3.0 | 中等数量警告 |
| 2.0 | 较多警告或少量严重问题 |
| 1.0 | 大量严重问题 |

---

## 五、异常处理

### 5.1 评分不达标

```markdown
❌ 发布阻断

**原因**: 质量评分未达标
**加权总分**: {分数}
**问题维度**: {维度}: {得分}

**建议**:
1. 完善 {问题内容}
2. 重新执行评分
```

### 5.2 规则文档缺失

```markdown
❌ 前置条件不满足

**缺失文档**:
- {文档路径}

**建议**:
1. 创建缺失的规则文档
2. 参考模板补充内容
```

### 5.3 追溯链断裂

```markdown
⚠️ 追溯关系不完整

**断裂位置**:
- {L1 文档} → {L2 文档}（缺失）

**建议**:
1. 补充缺失的追溯关系
2. 更新文档的 traces_from/traces_to
```

---

## 六、输出模板

### 6.1 发布报告模板

```markdown
# 项目名称 v{VERSION} 发布成果报告

**报告日期**: {DATE}  
**评分依据**: Governance/rules/rules_release.md

## 质量评分结论

| 维度 | 得分 | 权重 | 加权得分 | 状态 |
|------|------|------|----------|------|
| D1 | {D1} | 20% | {D1×0.2} | {状态} |
| D2 | {D2} | 15% | {D2×0.15} | {状态} |
| D3 | {D3} | 30% | {D3×0.3} | {状态} |
| D4 | {D4} | 25% | {D4×0.25} | {状态} |
| D5 | {D5} | 10% | {D5×0.1} | {状态} |
| **总分** | - | 100% | **{总分}** | - |

**质量评级**: {评级}  
**发布建议**: {建议}

## 详细分析
[各维度详细说明]

## 改进建议
[后续改进方向]
```

### 6.2 ReleaseNote 模板

```markdown
# 项目名称 v{VERSION} Release Notes

## 概述
- **版本**: v{VERSION}
- **发布日期**: {DATE}
- **发布类型**: {Major/Minor/Patch}

## 新功能
- [新增] {功能描述}

## Bug 修复
- [修复] {问题描述}

## 技术变更
- {变更描述}

## 升级指南
{升级步骤}
```

---

## 七、关联文档

- [治理总览](../Governance/GOVERNANCE_OVERVIEW.md)
- [发布管理规则](../Governance/rules/rules_release.md)
- [Git Tag 规范](../Governance/rules/rules_tag.md)
- [开发检查清单](../Governance/checklists/dev_checklist.md)
- [AI 开发指南](AI_Development_Guide.md)

